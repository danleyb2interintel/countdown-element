<link rel="import" href="../polymer/polymer.html">

<!--
`countdown-element`
A time countdown element

@demo demo/index.html 
-->

<dom-module id="countdown-element">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <template is="dom-if" if="{{running}}" restamp="true">
            <div class="timer">

                    <h3><span class="message"></span></h3>
                    <h2 style="text-align: center">
                        <span class="timeLefthours">{{timeLeft.hours}}</span> :
                        <span class="timeLeftminutes"> {{timeLeft.minutes}}</span> :
                        <span class="timeLeftseconds">{{timeLeft.seconds}} </span>
                    </h2>
                </div>
        </template>
        <template is="dom-if" if="{{!running}}" restamp="true">
            <div class="after">
                    <a class="link" on-tap="_iframe" href="{{link}}">{{linkMessage}}</a>
                </div>
        </template>

    </template>

    <script>
        Polymer({

            is: 'countdown-element',

            properties: {
                timeLeft: {
                    type: Object,
                    observer: '_timeLeftChanged'
                },
                message: {
                    type: String,
                    value: "countdown ends in"
                },
                duration: String,
                untill: String,
                timeout: {
                    type: Number,
                    value: 1000
                },
                tickFtns: {
                    type: Array,
                    value: []
                },
                running: {
                    type:Boolean,
                    notify:true
                },
                link:{
                    type:String,
                    value:'#'
                },
                linkMessage:{
                    type:String,
                    value:'View Live Bidding'
                }

            },
            ready: function () {
                this.duration = (new Date(this.untill) - new Date()) / 1000;
                //Polymer.dom(this).querySelector('.link').setAttribute('href',this.link);
                //Polymer.dom(this).querySelector('.link').textContent(this.linkMessage);
                this.start()
            },
            _timeLeftChanged: function (newValue, oldValue) {
                /*
                Polymer.dom(this).querySelector('.message').textContent = this.message;

                if (this.running) {
                    Polymer.dom(this).querySelector('.timeLefthours').textContent = this.timeLeft.hours;
                    Polymer.dom(this).querySelector('.timeLeftminutes').textContent = this.timeLeft.minutes;
                    Polymer.dom(this).querySelector('.timeLeftseconds').textContent = this.timeLeft.seconds;
                }
                */


            },
            _iframe: function (evt) {
                //c=evt;

                evt.preventDefault();
                window.open(evt.target.href,'_blank','location=yes,height=570,scrollbars=yes,status=yes');


            },

            start: function () {
                if (this.running) {
                    return;
                }
                this.running = true;
                var start = Date.now(),
                        that = this,
                        diff, obj;

                (function timer() {
                    diff = that.duration - (((Date.now() - start) / 1000) | 0);

                    if (diff > 0) {
                        setTimeout(timer, that.timeout);
                    } else {
                        diff = 0;
                        that.running = false;
                    }

                    obj = that.parse(diff);
                    that.timeLeft = obj;
                    that.tickFtns.forEach(function (ftn) {
                        ftn.call(this, obj.minutes, obj.seconds);
                    }, that);
                }());
            },

            onTick: function (ftn) {
                if (typeof ftn === 'function') {
                    this.tickFtns.push(ftn);
                }
                return this;
            },

            expired: function () {
                return !this.running;
            },

            parse: function (fullSeconds) {
                //console.log(fullSeconds);

                var sec_num = parseInt(fullSeconds, 10); // don't forget the second param
                var hours = Math.floor(sec_num / 3600);
                var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
                var seconds = sec_num - (hours * 3600) - (minutes * 60);

                if (hours < 10) {
                    hours = "0" + hours;
                }
                if (minutes < 10) {
                    minutes = "0" + minutes;
                }
                if (seconds < 10) {
                    seconds = "0" + seconds;
                }


                return {
                    'hours': hours,
                    'minutes': minutes,
                    'seconds': seconds
                    //'seconds': (seconds % 60) | 0
                    //'seconds': (seconds % 60) | 0
                };
            }

        });
    </script>
</dom-module>
